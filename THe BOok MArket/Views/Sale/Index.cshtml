
@model IEnumerable<THe_BOok_MArket.Models.Customer>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/Layout12.cshtml";
}

<strong style="margin-bottom:20px">List of sales </strong>

<div class="panel panel-default">
    <div class="panel-heading">
        <div class="row">
            <h2 class="panel-title modal pull-right" style="margin-right:20px;">
            </h2>
            <button style="margin-right:20px" class="btn btn-primary pull-right" onclick="addNewOrder()">Make new Sale</button>
        </div>
    </div>
    <hr />

    @if (Model.Count() != 0)
    {

        foreach (var item in Model)
        {

            <div class="panel-body" id="Sale_ID">
                <table class="table table-striped table-responsive">
                    <tbody>
                        <tr>
                            <td>Customer Name : @item.Customer_Name </td>
                            <td>Phone Number : @item.Customer_Contact </td>
                            <td>Item(s) : @item.Product_Name </td>
                            <td>Served By : @item.Customer_Surname</td>
                            <td>Sale Date :@item.Date  </td>
                        </tr>


                        <tr>
                            <td colspan="3">
                                <table class="table table-bordered">
                                    <tbody>
                                        <tr>
                                            <th>No.of Items</th>
                                            <th>Unit Price</th>
                                            <th>Total</th>

                                        </tr>
                                        @{
                                            var TaxRate = 0.15;
                                            var totalBill = 0;
                                            var GrandTotal = 0;
                                        }

                                        @foreach (var order in item.Sales)
                                        {
                                            <tr>
                                                <td>@order.Quantity</td>
                                                <td>@order.Price</td>
                                                <td>@order.Total</td>

                                            </tr>
                                            totalBill = totalBill + @Convert.ToInt32(order.Total);
                                            TaxRate = TaxRate * @Convert.ToInt32(order.Total);
                                            GrandTotal = (totalBill - @Convert.ToInt32(TaxRate));

                                        }
                                    </tbody>
                                </table>
                                <span class="pull-right" style="margin-right:100px;"><small>Total :  </small> @totalBill</span>
                                <span class="pull-right" style="margin-right:100px;"><small>Tax :  </small> @TaxRate</span>
                                <span class="pull-right" style="margin-right:100px;"><strong>Total Due: </strong> @GrandTotal</span>

                            </td>
                        </tr>
                    </tbody>
                </table>
                <input type="button" style="margin-bottom:50px" value="View sale" onclick="printDiv()">
            </div>

        }

    }
    else
    {
        <div class="panel-body">
            <h3 style="color:red;">No Sale records yet!</h3>
        </div>

    }
</div>
<div class="modal fade" id="newOrderModal">
    <div class="modal-dialog modal-lg" style=" width: 950px !important;">
        <div class="modal-content">
            <div class="modal-header">
                <a href="#" class="close" data-dismiss="modal">&times;</a>
                <h4>Add sale item(s)</h4>
            </div>
            <form id="NewOrderForm">
                <div class="modal-body">
                    @*Supplier Details*@
                    <h5 style="color:#ff6347">Sale Details</h5>
                    <hr />
                    <p>
                        @using (Html.BeginForm("Index", "Customer", FormMethod.Get))
                        {

                            <b>SearchBy:</b> @Html.RadioButton("searchBy", "Name", true) <text>Name</text>
                            @Html.RadioButton("searchBy", "Surname") <text>Surname</text>
                            <br />


                            @Html.TextBox("search") <input type="submit" value="Search" />

                        }
                    </p>
                    <div class="form-horizontal">
                        <input type="hidden" id="Customer_ID" />
                        <div class="form-group">
                            <label class="control-label col-md-10">
                                Name
                            </label>
                            <div class="col-md-10">
                                <input type="text" id="name" name="name" placeholder="Name" class="form-control" />
                            </div>
                            <label class="control-label col-md-10">
                                Contact
                            </label>
                            <div class="col-md-10">
                                <input type="number" id="phone" name="phone" placeholder="Phone" class="form-control" />
                            </div>
                            <label class="control-label col-md-10">
                                Item(s)
                            </label>
                            <div class="col-md-10">
                                <input type="text" id="product" name="product" placeholder="Item" class="form-control" />
                            </div>
                           
                        </div>
                    </div>

                    @*Purchase Details*@
                    <h5 style="margin-top:10px;color:#ff6347">Payment Details</h5>
                    <hr />
                    <div class="form-horizontal">
                        <input type="hidden" id="Purchase_ID" />
                        <div class="form-group">

                            <label class="control-label col-md-10">
                                Quantity
                            </label>
                            <div class="col-md-10">
                                <input type="number" id="quantity" name="quantity" placeholder="Quantity" class="form-control" />
                            </div>


                            <label class="control-label col-md-10">
                                Price
                            </label>
                            <div class="col-md-10">
                                <input type="number" id="price" name="price" placeholder=" Price" class="form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-md-6 col-lg-offset-4">
                                <a id="addToList" class="btn btn-primary">Add item(s) to List</a>
                            </div>
                        </div>

                        <table id="detailsTable" class="table">
                            <thead>
                                <tr>

                                    <th style="width:30%">Quantity</th>
                                    <th style="width:30%">Unit Price</th>
                                    <th style="width:30%">Amount</th>
                                    <th style="width:10%"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="reset" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="saveOrder" type="submit" class="btn btn-danger">Save Sale</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>


    function printDiv() {

        var divToPrint = document.getElementById('Sale_ID');
        var htmlToPrint = '' +
            '<style type="text/css">' +
            'table th, table td {' +
            'border:1px solid #000;' +
            'padding;0.5em;' +
            '}' +
            '</style>';
        htmlToPrint += divToPrint.outerHTML;
        newWin = window.open("");
        newWin.document.write("<h3 align='center'>The Book Market</h3>");
        newWin.document.write("<h3 align='center'>Sale invoice</h4>");
        newWin.document.write(htmlToPrint);
        newWin.print();
        newWin.close();
    }


</script>

@section scripts{
    <script>
        //Show Modal.
        function addNewOrder() {
            $("#newOrderModal").modal();
        }
        //Add Multiple Order.
        $("#addToList").click(function (e) {
            e.preventDefault();

            if ($.trim($("#quantity").val()) == "" || $.trim($("#price").val()) == "") return;

            var quantity = $("#quantity").val()
                price = $("#price").val(),
                detailsTableBody = $("#detailsTable tbody");

            var productItem = '<tr><td>' + quantity + '</td><td>' + price + '</td><td>' + (parseInt(quantity) * parseFloat(price)) + '</td><td><a data-itemId="0" href="#" class="deleteItem">Remove</a></td></tr>';
            detailsTableBody.append(productItem);
            clearItem();
        });
        //After Add A New Order In The List, Clear Clean The Form For Add More items.
        function clearItem() {
            $("#quantity").val('');
            $("#price").val('');

        }
        // After Add A New purchase In The List, If You Want, You Can Remove It.
        $(document).on('click', 'a.deleteItem', function (e) {
            e.preventDefault();
            var $self = $(this);
            if ($(this).attr('data-itemId') == "0") {
                $(this).parents('tr').css("background-color", "#ff6347").fadeOut(800, function () {
                    $(this).remove();
                });
            }
        });
        //After Click Save Button Pass All Data View To Controller For Save Database
        function saveOrder(data) {

            console.log(data);
            return $.ajax({
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                url: "/Sale/SaveOrder",
                data: data,
                success: function (result) {
                    alert(result);
                    location.reload();
                },
                error: function () {
                    alert("Error!")
                }
            });
        }
        //Collect Multiple Order List For Pass To Controller
        $("#saveOrder").click(function (e) {
            e.preventDefault();

            var orderArr = [];
            orderArr.length = 0;

            $.each($("#detailsTable tbody tr"), function () {
                orderArr.push({
                    quantity: $(this).find('td:eq(0)').html(),
                    price: $(this).find('td:eq(1)').html(),
                    amount: $(this).find('td:eq(2)').html(),



                });
            });


            var data = JSON.stringify({
                name: $("#name").val(),
                phone: $("#phone").val(),
                product: $("#product").val(),
               
                order: orderArr
            });

            $.when(saveOrder(data)).then(function (response) {
                console.log(response);
            }).fail(function (err) {
                console.log(err);
            });
        });
    </script>
}

















